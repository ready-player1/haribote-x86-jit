# haribote-x86-jit

[![License: MIT](https://img.shields.io/badge/License-MIT-brightgreen.svg)](https://github.com/ready-player1/haribote-x86-jit/blob/main/LICENSE.md)

このリポジトリは、私が[「10日くらいでできる！プログラミング言語自作入門」の続編](http://essen.osask.jp/?a21_txt02)のJITコンパイラ編を読みながら、その理解のために書いたはりぼて言語の処理系のソースコード置き場です。

はりぼて言語は、川合秀実さんが開発しているプログラミング言語です。2021年にWebコンテンツ「[10日くらいでできる！プログラミング言語自作入門](http://essen.osask.jp/?a21_txt01)」で発表されました。

> 私はプログラミング言語は（世間の人が思っているよりは）ずっと簡単に作れるものだと思っています。・・・今からここにそのためのテキストを置きます。これを読んで是非作れるようになってください。そうすれば「作りたいけど、作り方が分からない」を卒業することができます。そして今後は「じゃあどんな言語を作ろうか」をメインで考えられるようになるのです。それはとても素敵なことだと思います。

JITコンパイラ編は、インタプリタ編で実装した最終バージョンのHL-9aをx86用またはx64用にJITコンパイラ化する内容です。

x86用・x64用のどちらでも、まず内部コードを出力する処理を機械語を出力する処理に書き換えます。その上で、レジスタ変数の導入や無駄なメモリアクセスの削減、コンパイル時の定数計算などの最適化を行います。

> 「JITコンパイラ」というのは「Just-In-Time コンパイラ」のことで、ソースファイルからコンパイルして実行ファイルを作る普通のコンパイラとは異なり、インタプリタで命令の実行を指示された瞬間に高速にコンパイルして実行するという仕組みのことです。
>
> この改造をすると、言語はCPUに依存するようになります。[…]またもし自力で改造する場合は、機械語に対する知識も必要になります。今まではC言語で普通に書くだけでうまくできたので、それと比べればハードルは高いです。
>
> しかしそれでも、やるだけの価値はあります。それほど高速になります。

> 単純にJITコンパイラ化するだけだと、最適化なしではあまり速くはなりません。しかしJITコンパイラ化しないと、速度の限界はすぐに来ます。JITコンパイラにしてしまえば、最適化を入れていくことで、どんどんスピードアップする余地ができるのです。

haribote-x86-jitは、2021年に写経したHL-9aをベースに変数名や関数名を説明的に変更しています。

## Dependencies

- `build-essential`
- `libc6-dev-i386`
- `aclib` (See [aclライブラリの入手方法](https://essen.osask.jp/?a21_txt01_9))


## Building on Ubuntu

```
$ gcc -I/path/to/acl_sdl2 -DAARCH_X64 -O3 -m32 -Wno-unused-result -o haribote main.c `sdl2-config --cflags --libs` -lm
```

#### Note

aclライブラリはSDL2.0版を使用。
